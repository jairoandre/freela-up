<div class="loadingRequest" ng-show="processingForm"><img src="assets/images/loading.gif" /></div>
<div class="blockContent" ng-show="processingForm"></div>

<div id="full_page">
  <div class="header">
    <a href="" ng-click="goBack()" class="back"><span class="glyphicon glyphicon-chevron-left"></span></a>

    <a class="title" href="" ng-hide="editingCategoryTitle" ng-click="editingCategoryTitle = true">{{ category.title }}</a>

    <div class="edit_label" ng-show="editingCategoryTitle">
      <input type="text" ng-model="category.title" />
      <a href="" ng-click="editingCategoryTitle = false">Salvar</a>

      <div class="clearfix"></div>
    </div>

    <div class="divider"></div>

    <a href="" ng-click="editCategoryOptions()" class="edit-information"><span class="glyphicon glyphicon-edit"></span>Alterar ícone e cor</a>

    <div ng-show="showSystemMessage" class="message-status fade-animation" ng-class="systemMessage.messageClass">
      <p><span class="glyphicon glyphicon-{{ systemMessage.icon }}"></span> {{ systemMessage.text }}</p>
    </div>

    <a href="" ng-click="send()" class="submit_button"><span ng-show="!updating">Cadastrar</span><span ng-show="updating">Atualizar</span></a>
  </div>

  <div class="spacing"></div>

  <div class="tabs">
    <a href="" ng-click="currentTab = 'fields'" ng-class="{'active': currentTab == 'fields'}">Campos</a>
    <a href="" ng-click="currentTab = 'statuses'" ng-class="{'active': currentTab == 'statuses'}">Estados</a>
    <a href="" ng-click="currentTab = 'triggers'" ng-class="{'active': currentTab == 'triggers'}" ng-hide="!hasPermission('manage_inventory_formulas')">Fórmulas</a>
    <a href="" ng-click="currentTab = 'configs'" ng-class="{'active': currentTab == 'configs'}">Configurações</a>
  </div>

  <div class="big_content" class="pages-animation" ng-hide="currentTab !== 'fields'">
    <div class="left_column">

      <div inventory-sortable-sections class="sortableSections">
        <div class="section" ng-repeat="section in category.sections | orderBy:'position'" ng-hide="section.destroy">
          <div class="top_part">
            <div class="type" inventory-edit-label="section">
              <a class="name" href="" ng-click="editLabel()" ng-hide="editingSectionLabel">{{ section.title }} <span ng-show="section.required == true">*</span></a>

              <div class="edit_label" ng-show="editingSectionLabel">
                <input type="text" ng-model="section.title" class="editLabelField" />
                <a href="" ng-click="saveLabel()">Salvar</a>

                <div class="clearfix"></div>
              </div>
            </div>

            <div class="actions">
              <div class="option move">
                <a href="" class="handle icon"><span class="glyphicon glyphicon-move"></span></a>
              </div>

              <div class="option trash" ng-hide="section.location === true">
                <div class="popover bottom" inventory-popover="remove" ng-show="popover.remove">
                  <div class="arrow"></div>
                  <h3 class="popover-title">Remover seção {{ section.title }}</h3>

                  <div class="popover-content">
                    <div class="row">
                      <div class="col-xs-6"><a href="" ng-click="popover.remove = false" class="btn btn-default btn-block">Cancelar</a></div>
                      <div class="col-xs-6"><a href="" ng-click="section.destroy = true" class="btn btn-danger btn-block">Remover</a></div>
                    </div>
                  </div>
                </div>

                <a href="" ng-click="openPopover('remove')" class="icon" inventory-popover-link><span class="glyphicon glyphicon-trash"></span></a>
              </div>

              <div class="option permissions">
                <div class="popover bottom" inventory-popover="permissions" ng-if="popover.permissions">
                  <div class="arrow"></div>
                  <h3 class="popover-title">Permissões da seção {{ section.label }}</h3>

                  <div class="popover-content">
                    <div class="form-group">
                      <label>Grupos que podem visualizar:</label>

                      <ui-select multiple ng-model="section.permissions.groups_can_view" ng-disabled="disabled" close-on-select="false" style="width: 300px;">
                        <ui-select-match placeholder="Digite um grupo">{{$item.name}}</ui-select-match>

                        <ui-select-choices repeat="group.id as group in groups | filter:$select.search">
                          {{group.name}}
                        </ui-select-choices>
                      </ui-select>
                    </div>

                    <div class="form-group">
                      <label>Grupos que podem editar:</label>

                      <ui-select multiple ng-model="section.permissions.groups_can_edit" ng-disabled="disabled" close-on-select="false" style="width: 300px;">
                        <ui-select-match placeholder="Digite um grupo">{{$item.name}}</ui-select-match>

                        <ui-select-choices repeat="group.id as group in groups | filter:$select.search">
                          {{group.name}}
                        </ui-select-choices>
                      </ui-select>
                    </div>

                    <a href="" ng-click="$parent.popover.permissions = false" class="btn btn-info btn-fat-custom btn-custom pull-right">Pronto</a>

                    <div class="clearfix"></div>
                  </div>
                </div>

                <a href="" ng-click="openPopover('permissions')" class="icon" inventory-popover-link><span class="glyphicon glyphicon-lock"></span></a>
              </div>

              <div class="option edit">
                <div class="popover bottom" inventory-popover="options" ng-show="popover.options">
                  <div class="arrow"></div>
                  <h3 class="popover-title">Opções da seção {{ section.title }}</h3>

                  <div class="popover-content">
                    <div class="form-group">
                      <label>Preenchimento requerido?</label>

                      <br />

                      <label class="radio-inline">
                        <input type="radio" ng-model="section.required" ng-value="true"> Sim
                      </label>

                      <label class="radio-inline">
                        <input type="radio" ng-model="section.required" ng-value="false"> Não
                      </label>
                    </div>

                    <a href="" ng-click="popover.options = false" class="btn btn-info btn-fat-custom btn-custom pull-right">Pronto</a>

                    <div class="clearfix"></div>
                  </div>
                </div>

                <a href="" ng-click="openPopover('options')" class="icon" inventory-popover-link><span class="glyphicon glyphicon-edit"></span></a>
              </div>
            </div>

            <div class="clearfix"></div>
          </div>

          <div class="middle">
            <!-- text field -->
            <div inventory-droppable-inputs-area class="droppableInputsArea">
              <div class="empty_section" ng-show="section.fields.length === 0"><p>Arreste os campos que você deseje adicionar a esta seção</p></div>

              <div class="input pages-animation" ng-repeat="field in section.fields | orderBy:'position'" id="input_{{ field.id }}" ng-hide="field.destroy">
                <div class="type">
                  <div inventory-edit-label>
                    <label for="generic_input_{{ field.id }}" class="input_name" ng-hide="editingLabel" ng-click="editLabel()">
                      <span ng-show="field.label !== null">{{ field.label }}</span>
                      <span ng-show="field.label == null">{{ field.title }}</span>
                      <span ng-show="field.required == true"> *</span>
                    </label>

                    <div class="edit_label" ng-show="editingLabel">
                      <input type="text" class="editLabelField" ng-model="label" />
                      <a href="" ng-click="saveLabel()">Salvar</a>

                      <div class="clearfix"></div>
                    </div>
                  </div>

                  <div class="clearfix"></div>

                  <!-- input type: text, url, email, textarea -->
                  <input class="form-control" id="generic_input_{{ field.id }}" type="text" ng-if="field.kind == 'text' || field.kind == 'url' || field.kind == 'email'" disabled="disabled">

                  <!-- textarea -->
                  <textarea class="form-control" id="generic_input_{{ field.id }}" type="text" ng-if="field.kind == 'textarea'" disabled="disabled"></textarea>

                  <!-- input type date, time, cpf, cnpj -->
                  <div class="custom_size col-xs-3" ng-if="field.kind == 'date' || field.kind == 'time' || field.kind == 'cpf' || field.kind == 'cnpj'">
                    <input class="form-control" id="generic_input_{{ field.id }}" type="text" disabled="disabled">
                  </div>

                  <!-- input type: integer, decimal -->
                  <input class="form-control integer" id="generic_input_{{ field.id }}" type="text" ng-if="field.kind == 'integer' || field.kind == 'decimal'" disabled="disabled">

                  <!-- input type: meters -->
                  <div class="input-group col-xs-3" ng-if="field.kind == 'meters'">
                    <input type="text" id="generic_input_{{ field.id }}" class="form-control" type="text" disabled="disabled">
                    <span class="input-group-addon">metros</span>
                  </div>

                  <!-- input type: centimeters -->
                  <div class="input-group col-xs-3" ng-if="field.kind == 'centimeters'">
                    <input type="text" id="generic_input_{{ field.id }}" class="form-control" type="text" disabled="disabled">
                    <span class="input-group-addon">cm</span>
                  </div>

                  <!-- input type: kilometers -->
                  <div class="input-group col-xs-3" ng-if="field.kind == 'kilometers'">
                    <input type="text" id="generic_input_{{ field.id }}" class="form-control" type="text" disabled="disabled">
                    <span class="input-group-addon">km</span>
                  </div>

                  <!-- input type: years -->
                  <div class="input-group col-xs-3" ng-if="field.kind == 'years'">
                    <input type="text" id="generic_input_{{ field.id }}" class="form-control" type="text" disabled="disabled">
                    <span class="input-group-addon">anos</span>
                  </div>

                  <!-- input type: months -->
                  <div class="input-group col-xs-3" ng-if="field.kind == 'months'">
                    <input type="text" id="generic_input_{{ field.id }}" class="form-control" type="text" disabled="disabled">
                    <span class="input-group-addon">meses</span>
                  </div>

                  <!-- input type: days -->
                  <div class="input-group col-xs-3" ng-if="field.kind == 'days'">
                    <input type="text" id="generic_input_{{ field.id }}" class="form-control" type="text" disabled="disabled">
                    <span class="input-group-addon">dias</span>
                  </div>

                  <!-- input type: hours -->
                  <div class="input-group col-xs-3" ng-if="field.kind == 'hours'">
                    <input type="text" id="generic_input_{{ field.id }}" class="form-control" type="text" disabled="disabled">
                    <span class="input-group-addon">horas</span>
                  </div>

                  <!-- input type: seconds -->
                  <div class="input-group col-xs-3" ng-if="field.kind == 'seconds'">
                    <input type="text" id="generic_input_{{ field.id }}" class="form-control" type="text" disabled="disabled">
                    <span class="input-group-addon">segundos</span>
                  </div>

                  <!-- input type: angle -->
                  <div class="input-group col-xs-3" ng-if="field.kind == 'angle'">
                    <span class="input-group-addon">ângulo</span>
                    <input type="text" id="generic_input_{{ field.id }}" class="form-control" type="text" disabled="disabled">
                  </div>

                  <!-- input type: images -->
                  <div ng-if="field.kind == 'images'" class="imagesField">
                    <p>Campo de imagens</p>
                  </div>

                  <!-- inputs that have multiple options -->
                  <div ng-if="kindHasMultipleOptions(field.kind) === true" class="multipleValues">
                    <div class="row">
                      <div class="col-xs-10 selectList">
                        <input class="form-control" type="text" disabled="disabled" placeholder="Selecione um item"><span class="caret"></span>
                      </div>

                      <div class="col-xs-2 editOptionsLink">
                        <a href="" ng-click="editFieldOptions(field)">Gerenciar opções</a>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="actions">
                  <div class="option move">
                    <a href="" class="handle icon"><span class="glyphicon glyphicon-move"></span></a>
                  </div>

                  <div class="option trash" ng-hide="field.location === true">
                    <div class="popover bottom" inventory-popover="remove" ng-if="popover.remove === true">
                      <div class="arrow"></div>
                      <h3 class="popover-title">Remover campo {{ field.label }}</h3>

                      <div class="popover-content">
                        <div class="row">
                          <div class="col-xs-6"><a href="" ng-click="$parent.popover.remove = false" class="btn btn-default btn-block">Cancelar</a></div>
                          <div class="col-xs-6"><a href="" ng-click="field.destroy = true" class="btn btn-danger btn-block">Remover</a></div>
                        </div>
                      </div>
                    </div>

                    <a href="" ng-click="openPopover('remove')" class="icon" inventory-popover-link><span class="glyphicon glyphicon-trash"></span></a>
                  </div>

                  <div class="option permissions">
                    <div class="popover bottom" inventory-popover="permissions" ng-if="popover.permissions === true">
                      <div class="arrow"></div>
                      <h3 class="popover-title">Permissões do campo {{ field.label }}</h3>

                      <div class="popover-content">
                        <div class="form-group">
                          <label>Grupos que podem visualizar:</label>

                          <ui-select multiple ng-model="field.permissions.groups_can_view" ng-disabled="disabled" close-on-select="false" style="width: 300px;">
                            <ui-select-match placeholder="Digite um grupo">{{$item.name}}</ui-select-match>

                            <ui-select-choices repeat="group.id as group in groups | filter:$select.search">
                              {{group.name}}
                            </ui-select-choices>
                          </ui-select>
                        </div>

                        <div class="form-group">
                          <label>Grupos que podem editar:</label>

                          <ui-select multiple ng-model="field.permissions.groups_can_edit" ng-disabled="disabled" close-on-select="false" style="width: 300px;">
                            <ui-select-match placeholder="Digite um grupo">{{$item.name}}</ui-select-match>

                            <ui-select-choices repeat="group.id as group in groups | filter:$select.search">
                              {{group.name}}
                            </ui-select-choices>
                          </ui-select>
                        </div>

                        <a href="" ng-click="$parent.popover.permissions = false" class="btn btn-info btn-fat-custom btn-custom pull-right">Pronto</a>

                        <div class="clearfix"></div>
                      </div>
                    </div>

                    <a href="" ng-click="openPopover('permissions')" class="icon" inventory-popover-link><span class="glyphicon glyphicon-lock"></span></a>
                  </div>

                  <div class="option edit">
                    <div class="popover bottom" inventory-popover="options" ng-show="popover.options">
                      <div class="arrow"></div>
                      <h3 class="popover-title">Opções do campo {{ field.label }}</h3>

                      <div class="popover-content">
                        <div class="form-group">
                          <label>Preenchimento requerido?</label>

                          <br />

                          <label class="radio-inline">
                            <input type="radio" ng-model="field.required" ng-value="true"> Sim
                          </label>

                          <label class="radio-inline">
                            <input type="radio" ng-model="field.required" ng-value="false"> Não
                          </label>
                        </div>

                        <div class="row">
                          <div class="col-xs-6">
                            <div class="form-group">
                              <label>Min. de caracteres</label>
                              <input type="number" class="form-control" ng-model="field.minimum" />
                            </div>
                          </div>

                          <div class="col-xs-6">
                            <div class="form-group">
                              <label>Máx. de caracteres</label>
                              <input type="number" class="form-control" ng-model="field.maximum" />
                            </div>
                          </div>
                        </div>

                        <a href="" ng-click="popover.options = false" class="btn btn-info btn-fat-custom btn-custom pull-right">Pronto</a>

                        <div class="clearfix"></div>
                      </div>
                    </div>

                    <a href="" ng-click="openPopover('options')" class="icon" inventory-popover-link><span class="glyphicon glyphicon-edit"></span></a>
                  </div>
                </div>

                <div class="clearfix"></div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <div class="right_column" inputs-sidebar>
      <a class="btn btn-info btn-custom btn-block btn-lg-custom" href="" ng-click="newSection()">+ Adicionar nova seção</a>

      <div class="inputs">
        <div class="info"><p>Arraste os campos que você deseja adicionar</p></div>

        <div class="clearfix"></div>

        <div class="simple_search">
          <span class="glyphicon glyphicon-search search_icon"></span>
          <input type="text" placeholder="Buscar..." ng-model="searchInputs" />
        </div>

        <div class="list">
          <div class="item" ng-repeat="input in availableInputs | filter: searchInputs" name="{{ input.kind }}" inventory-draggable-input><p>{{ input.name }}</p></div>
        </div>
      </div>
    </div>

    <div class="clearfix"></div>
  </div>

  <div class="big_content" class="pages-animation" ng-if="currentTab === 'statuses'">
    <div class="toolbar">
      <div class="pull-left">Obrigatório o uso de estados <input bs-switch type="checkbox" class="pull-right" ng-model="category.require_item_status"></div>

      <a href="" ng-click="newStatus()" class="btn btn-info btn-custom pull-right">+ Novo estado</a>

      <div class="clearfix"></div>
    </div>

    <table class="simple_table">
      <tr ng-repeat="status in category.statuses" class="pages-animation">
        <td><b ng-style="{'color': status.color}">{{ status.title }}</b></td>
        <td class="actions">
          <a class="icon_action" href="" ng-click="editStatus(status)"><span class="glyphicon glyphicon-edit"></span></a>
          <a class="icon_action" href="" ng-click="removeStatus(status)"><span class="glyphicon glyphicon-trash"></span></a>
        </td>
      </tr>
    </table>
  </div>

  <div class="big_content pages-animation edit-triggers" ng-if="currentTab === 'triggers'">
    <div class="edit-triggers-header clearfix">
      <p>{{ triggers.length }} gatilhos criados</p>
      <a href="" ng-click="newTrigger()" class="btn btn-info btn-custom">+ Novo gatilho</a>
    </div>

    <ul>
      <li ng-repeat="trigger in triggers" inventory-trigger>
        <div class="saving" ng-show="processingForm"></div>

        <div class="list-triggers-item" ng-class="{'active': editing == true}">
          <div class="item-content">
            <p class="name" ng-hide="editing">{{ trigger.title }}</p>
            <input class="edit-trigger-title form-control" ng-show="editing" ng-model="trigger.title" placeholder="Título do gatilho" />

            <div class="actions">
              <a href="" ng-click="removeTrigger()"><span class="glyphicon glyphicon-trash"></span></a>

              <a href="" class="middle-link" ng-click=""><span class="glyphicon glyphicon-resize-vertical"></span></a>

              <a href="" class="right-link" ng-click="editing = false" ng-show="editing"><span class="arrow_icon"></span></a>

               <a href="" class="right-link" ng-click="editing = true" ng-hide="editing"><span class="arrow_icon"></span></a>
            </div>

            <div class="clearfix"></div>
          </div>

          <table class="item-table" ng-show="editing">
            <thead ng-hide="trigger.trigger_conditions.length == 0">
              <tr>
                <td width="35%">Campo</td>
                <td width="25%">Condição</td>
                <td width="35%">Campo</td>
                <td width="5%"></td>
              </tr>
            </thead>
            <tbody>

              <tr ng-repeat="condition in trigger.trigger_conditions">
                <td>
                  <label class="select-trigger">
                    <select class="form-control" ng-model="condition.field.id" ng-options="field.id as field.title for field in fields"></select>
                  </label>
                </td>

                <td>
                  <label class="select-trigger">
                    <select class="form-control" ng-model="condition.condition_type" ng-options="type.id as type.name for type in types"></select>
                  </label>
                </td>

                <td>
                  <input type="text" class="form-control" ng-model="condition.values[0]">
                </td>

                <td class="remove-condition">
                  <button type="button" class="remove" ng-click="removeCondition(condition)">x</button>
                </td>
              </tr>

              <tr>
                <td colspan="4" class="new-condition">
                  <a href="" ng-click="newCondition()" class="btn btn-info btn-custom">+ Nova condição</a>
                </td>
              </tr>
            </tbody>
          </table>

          <div class="item-conditions" ng-show="editing">
            <h3>Caso as condições sejam verdadeiras</h3>
            <form>
              <div class="form-group clearfix">
                <div class="item-conditions-content content-first">
                  <label for="">Selecione uma ação</label>

                  <label class="select-trigger">
                    <select class="form-control" ng-model="trigger.action_type" ng-options="type.action as type.name for type in action_types"></select>
                  </label>
                </div>

                <div class="item-conditions-content" ng-show="trigger.action_type == 'disable_steps'">
                  <label for="">Desativar as etapa(s)</label>

                  <div class="clearfix"></div>
                    <select class="multiple-select" ui-select2 ng-model="trigger.action_values" data-placeholder="Digite uma etapa" multiple>
                      <option ng-repeat="step in flow.steps" value="{{ step.id }}">{{ step.title }}</option>
                    </select>
                </div>

                <div class="item-conditions-content" ng-show="trigger.action_type == 'enable_steps'">
                  <label for="">Ativar as etapa(s)</label>

                  <div class="clearfix"></div>
                    <select class="multiple-select" ui-select2 ng-model="trigger.action_values" data-placeholder="Digite uma etapa" multiple>
                      <option ng-repeat="step in flow.steps" value="{{ step.id }}">{{ step.title }}</option>
                    </select>
                </div>

                <div class="item-conditions-content" ng-show="trigger.action_type == 'finish_flow'">
                  <label for="">Finalizar o caso com o estado</label>

                  <label class="select-trigger">
                    <select class="form-control" ng-model="trigger.action_values[0]" ng-options="state.id as state.title for state in flow.resolution_states"></select>
                  </label>
                </div>

                <div class="item-conditions-content" ng-show="trigger.action_type == 'transfer_flow'">
                  <label for="">Transferir para o fluxo</label>

                  <label class="select-trigger">
                    <select class="form-control" ng-model="trigger.action_values[0]" ng-options="flow.id as flow.title for flow in flows"></select>
                  </label>
                </div>

              </div>

              <div class="form-group">
                <label for="">Descrição</label>

                <textarea class="form-control" rows="4" placeholder="Caso finalizado devido a impossibilidade técnica" ng-model="trigger.description"></textarea>
              </div>

              <div class="save-trigger">
                <button href="" ng-click="saveTrigger()" class="btn btn-info btn-custom">Salvar gatilho</button>
              </div>

              <div class="clearfix"></div>
            </form>
          </div>
        </div>
      </li>
    </ul>
  </div>

  <div class="big_content pages-animation" ng-if="currentTab === 'configs'" style="padding: 40px">
      <p>Por padrão essa categoria não é pública, você pode torná-la visível aos munícipes adicionando o grupo <b>Público</b> para ver este inventário.</p>

      <hr />

      <div class="form-group">
        <label>Grupos com permissões para editar</label>

        <div class="selectGroups">
          <div class="simple_search">
            <span class="glyphicon glyphicon-search search_icon"></span>
            <input type="text" placeholder="Buscar grupos..." ng-model="category.permissions.groups_can_edit" ui-autocomplete="groupsCanEditAutocomplete" />
          </div>

          <ul>
            <li ng-repeat="group in category.permissions.groups_can_edit">{{ group.name }} <button type="button" class="remove" ng-click="removeGroupCanEdit(group)">×</button></li>
          </ul>
        </div>

      </div>

      <hr />

      <div class="form-group">
        <label>Grupos com permissões para ver</label>

        <div class="selectGroups">
          <div class="simple_search">
            <span class="glyphicon glyphicon-search search_icon"></span>
            <input type="text" placeholder="Buscar grupos..." ng-model="category.permissions.groups_can_view" ui-autocomplete="groupsCanViewAutocomplete" />
          </div>

          <ul>
            <li ng-repeat="group in category.permissions.groups_can_view">{{ group.name }} <button type="button" class="remove" ng-click="removeGroupCanEdit(group)">×</button></li>
          </ul>
        </div>

      </div>
  </div>
</div>
