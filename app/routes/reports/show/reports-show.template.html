<div class="loading" ng-show="loading"></div>

<div ng-hide="loading" class="pages-animation">
  <div class="title">
    <ul>
      <li><a ng-href="#/reports">Relatos</a></li>
      <li>{{ report.address }}</li>
    </ul>

    <a href="" ng-click="print()" class="btn btn-info btn-custom"><i class="glyphicon glyphicon-print"></i></a>
  </div>

  <ul class="report-menu" reports-menu>
    <li du-scrollspy="report-data"><a href="#report-data" du-smooth-scroll>Dados do relato</a></li>
    <li ng-if="report.images.length != 0" du-scrollspy="report-images"><a href="#report-images" du-smooth-scroll>Imagens</a></li>
    <li du-scrollspy="report-map"><a href="#report-map" du-smooth-scroll>Mapa</a></li>
    <li du-scrollspy="report-author"><a href="#report-author" du-smooth-scroll>Informações do munícipe</a></li>
    <li du-scrollspy="report-responses"><a href="#report-responses" du-smooth-scroll>Respostas ao munícipe</a></li>
    <li du-scrollspy="report-comments" ng-show="hasPermission('reports_full_access') || hasPermission('reports_categories_edit', report.category.id) || hasPermission('reports_items_edit', report.category.id) || hasPermission('reports_items_read_private', report.category.id) || hasPermission('reports_items_create_internal_comment', report.category.id)"><a href="#report-comments" du-smooth-scroll>Observações internas</a></li>
    <li du-scrollspy="report-history"><a href="#report-history" du-smooth-scroll>Histórico</a></li>

    <div class="clearfix"></div>
  </ul>

  <div class="content wrappers reports-show">
    <div class="rounder_wrapper" id="report-data">
      <div class="wrapper_title"><h1>Dados do relato</h1></div>

      <div class="status-bar" ng-repeat="status in report.category.statuses" ng-if="status.id == report.status_id">
        <div class="background" ng-style="{ 'background-color': status.color }"></div>

        <p class="pull-left" ng-style="{ 'color': status.color }">{{ status.title }}</p>

        <a class="pull-right" ng-click="editReportStatus(report, report.category)" href="" ng-show="hasPermission('reports_full_access') || hasPermission('reports_categories_edit', report.category.id) || hasPermission('reports_items_edit', report.category.id) || hasPermission('reports_items_alter_status', report.category.id)">Alterar status</a>

        <div class="clearfix"></div>
      </div>

      <div class="fields">
        <div ng-show="hasPermission('reports_full_access') || hasPermission('reports_categories_edit', report.category.id) || hasPermission('reports_items_edit', report.category.id) || hasPermission('reports_items_read_private', report.category.id)">
          <h5>Protocolo</h5>
          <p>{{ report.protocol }} <span class="label label-danger" ng-show="report.overdue">ATRASADO</span></p>

          <hr />
        </div>

        <div class="report-data">
          <h5>Endereço</h5>
          <p ng-if="!editingAddress">
            {{ report.address }}<span ng-if="report.number">, {{ report.number }}</span><span ng-if="report.postal_code">, {{ report.postal_code }}</span><span ng-if="report.district">, {{ report.district }}</span><span ng-if="report.state"> - {{ report.state }}</span><span ng-if="report.country">, {{ report.country }}</span>
          </p>
          <div ng-if="editingAddress">
            <form ng-submit="saveAddress(addressForm)" name="addressForm" novalidate next-field-on-enter="fieldOnEnter">
            <div class="row">
              <div class="search-map col-xs-7">
                <span class="loading-automcomplete-request" ng-show="showLoadingForAutocompleteRequest"><i class="refresh glyphicon glyphicon-refresh rotating"></i></span>
                <input required name="address" ng-class="{'has-error': addressForm.address.$invalid && (!addressForm.address.$pristine || addressForm.$submitted)}" class="searchField" placeholder="Logradouro" ng-model="address.address" report-search-map ng-keypress="showLoading()">
              </div>

              <div class="col-xs-2" ng-class="{'has-error': addressForm.number.$invalid && (!addressForm.number.$pristine || addressForm.$submitted)}">
                <input type="number" ng-model="address.number" name="number" placeholder="N." class="form-control reference-field" />
              </div>

              <div class="col-xs-3" ng-class="{'has-error': addressForm.reference.$invalid && (!addressForm.reference.$pristine || addressForm.$submitted)}">
                <input type="text" ng-model="address.reference" name="reference" placeholder="Referência" class="form-control reference-field" />
              </div>

              <div class="col-md-2" ng-class="{'has-error': addressForm.district.$invalid && (!addressForm.district.$pristine || addressForm.$submitted)}">
                <input required type="text" ng-model="address.district" name="district" placeholder="Bairro" class="form-control reference-field" />
              </div>

              <div class="col-md-2" ng-class="{'has-error': addressForm.postal_code.$invalid && (!addressForm.postal_code.$pristine || addressForm.$submitted)}">
                <input required type="text" ng-model="address.postal_code" name="postal_code" placeholder="CEP" class="form-control reference-field" />
              </div>

              <div class="col-md-3" ng-class="{'has-error': addressForm.city.$invalid && (!addressForm.city.$pristine || addressForm.$submitted)}">
                <input required type="text" name="city" ng-model="address.city" placeholder="Cidade" class="form-control reference-field" />
              </div>

              <div class="col-md-3" ng-class="{'has-error': addressForm.state.$invalid && (!addressForm.state.$pristine || addressForm.$submitted)}">
                <input required type="text" name="state" ng-model="address.state" placeholder="Estado" class="form-control reference-field" />
              </div>

              <div class="col-md-2" ng-class="{'has-error': addressForm.country.$invalid && (!addressForm.country.$pristine || addressForm.$submitted)}">
                <input required type="text" name="country" ng-model="address.country" placeholder="País" class="form-control reference-field" />
              </div>
            </div>

            <div class="form-group reportMap">
              <div class="map-alert update-address" ng-show="markerPositionUpdated && !markerOutOfBounds"><a href="" ng-click="updateMarkerAddress()">Clique aqui</a> para atualizar o endereço do relato de acordo com a posição do marcador.</div>
              <div class="map-alert out-of-bounds" ng-show="markerOutOfBounds">O endereço não pertence ao município.</div>

              <div class="loadingMap" ng-show="isLoadingItems">
                <div class="loadingScrolling"></div>
              </div>

              <div class="roundedMap" map-new-report></div>
            </div>

              <div class="pull-right edit-address-actions" ng-if="editingAddress">
                <a class="btn btn-default btn-fat-custom" ng-click="cancelAddressEdit()" ng-if="!savingAddress">Cancelar</a>
                <input type="submit" value="Salvar" class="btn btn-info btn-fat-custom btn-custom" ng-disabled="savingAddress">
              </div>


            </form>
          </div>

          <a href="" class="link" ng-if="!editingAddress" ng-click="editAddress()" ng-show="hasPermission('reports_full_access') || hasPermission('reports_categories_edit', report.category.id) || hasPermission('reports_items_edit', report.category.id)">Editar</a>

          <div class="clearfix"></div>
        </div>

        <div class="report-data">
          <hr />

          <h5>Referência</h5>
          <p>{{ report.reference }}</p>
          <p ng-show="report.reference == null || report.reference == ''">Não informado.</p>

          <a href="" class="link" ng-click="editReference()" ng-show="hasPermission('reports_full_access') || hasPermission('reports_categories_edit', report.category.id) || hasPermission('reports_items_edit', report.category.id)">Editar</a>

          <div class="clearfix"></div>
        </div>

        <div class="report-data">
          <hr />

          <h5>Descrição</h5>
          <p>{{report.description}}</p>
          <p ng-show="report.description == null || report.description == ''">Não informado.</p>

          <a href="" class="link" ng-click="editDescription()" ng-show="hasPermission('reports_full_access') || hasPermission('reports_categories_edit', report.category.id) || hasPermission('reports_items_edit', report.category.id)">Editar</a>

          <div class="clearfix"></div>
        </div>

        <hr />

        <div class="report-data">
          <h5>Categoria</h5>
          <p>{{ report.category.title }}</p>

          <a href="" class="link" ng-click="editCategory()" ng-show="hasPermission('reports_full_access') || hasPermission('reports_categories_edit', report.category.id) || hasPermission('reports_items_edit', report.category.id)">Alterar</a>

          <div class="clearfix"></div>
        </div>

        <hr />

        <h5>Data de cadastro</h5>
        <p>{{ report.created_at | date:'dd/MM/yy HH:mm'}}</p>

        <hr />

        <div class="report-data">
          <h5>Status</h5>
          <p><span ng-repeat="status in report.category.statuses" ng-show="status.id == report.status_id">{{ status.title }}</span></p>

          <a href="" class="link" ng-click="editReportStatus(report, report.category)" ng-show="hasPermission('reports_full_access') || hasPermission('reports_categories_edit', report.category.id) || hasPermission('reports_items_edit', report.category.id) || hasPermission('reports_items_alter_status', report.category.id)">Alterar</a>

          <div class="clearfix"></div>
        </div>

        <div ng-show="report.inventory_item">
          <hr />

          <h5>Item relacionado</h5>

          <p><a ng-href="#/items/{{ report.inventory_item.id }}">{{ report.inventory_item.title }}</a></p>
        </div>

        <hr />

        <div class="report-data">
          <h5>Grupo responsável</h5>

          <p ng-show="report.assigned_group">{{ report.assigned_group.name }}</p>
          <p ng-show="!report.assigned_group">Não há um grupo responsável pelo relato.</p>

          <a href="" class="link" ng-click="forwardReport()" ng-show="(hasPermission('reports_full_access') || hasPermission('reports_categories_edit', report.category.id) || hasPermission('reports_items_edit', report.category.id) || hasPermission('reports_items_forward', report.category.id)) && category.solver_groups_ids.length !== 0">Alterar</a>

          <div class="clearfix"></div>
        </div>

        <div class="report-data" ng-show="report.assigned_group">
          <hr />

          <h5>Usuário responsável</h5>

          <p ng-show="report.assigned_user">{{ report.assigned_user.name }}</p>
          <p ng-show="!report.assigned_user">Não há um usuário responsável pelo relato.</p>

          <a href="" class="link" ng-click="assignReport()" ng-show="hasPermission('reports_full_access') || hasPermission('reports_categories_edit', report.category.id) || hasPermission('reports_items_edit', report.category.id)">Alterar</a>

          <div class="clearfix"></div>
        </div>

      </div>
    </div>

    <div class="rounder_wrapper" ng-hide="report.images.length == 0" id="report-images">
      <div class="wrapper_title"><h1>Imagens</h1></div>

      <div class="fields">
        <gallery images="images"></gallery>

        <div class="clearfix"></div>
      </div>
    </div>

    <div class="rounder_wrapper" id="report-map">
      <div class="wrapper_title"><h1>Mapa</h1></div>

      <div class="fields">
        <div class="roundedMap" map-show-report></div>
      </div>
    </div>

    <div class="rounder_wrapper" id="report-author">
      <div class="wrapper_title"><h1>Informações do munícipe</h1></div>

      <div class="fields">
        <h5>Nome completo do munícipe</h5>
        <p ng-show="hasPermission('reports_full_access')"><a href="#/users/{{ report.user.id }}">{{ report.user.name }}</a></p>
        <p ng-show="!hasPermission('reports_full_access')">{{ report.user.name }}</p>

        <hr />

        <h5>Email</h5>
        <p>{{ report.user.email }}</p>

        <hr />

        <h5>Telefone</h5>
        <p>{{ report.user.phone }}</p>
      </div>
    </div>

    <div class="rounder_wrapper" ng-show="feedback" ng-show="hasPermission('reports_full_access') || hasPermission('reports_categories_edit', report.category.id) || hasPermission('reports_items_edit', report.category.id) || hasPermission('reports_items_create_comment', report.category.id) || hasPermission('reports_items_read_private', report.category.id)">
      <div class="wrapper_title"><h1>Feedback do usuário</h1></div>

      <div class="fields">
        <h5>Feedback do usuário</h5>

        <p ng-show="feedback.kind == 'positive'">Positivo</p>
        <p ng-show="feedback.kind != 'positive'">Negativo</p>

        <hr />

        <h5>Comentário</h5>
        <p>{{ feedback.content }}</p>

        <hr />

        <div ng-hide="feedback.images.length == 0">
          <h5>Imagens</h5>

          <gallery images="feedback.images"></gallery>

          <div class="clearfix"></div>
        </div>
      </div>
    </div>

    <div class="rounder_wrapper" id="report-responses" ng-show="hasPermission('reports_full_access') || hasPermission('reports_categories_edit', report.category.id) || hasPermission('reports_items_edit', report.category.id) || hasPermission('reports_items_create_comment', report.category.id) || hasPermission('reports_items_read_private', report.category.id)">
      <div class="wrapper_title"><h1>Respostas ao munícipe</h1></div>

      <div class="fields">
        <div class="user-message" ng-show="hasPermission('reports_full_access') || hasPermission('reports_categories_edit', report.category.id) || hasPermission('reports_items_edit', report.category.id) || hasPermission('reports_items_create_comment', report.category.id)">
          <div class="avatar">
            <img src="assets/images/avatar_default.jpg" />
          </div>

          <div class="infos">
            <h2>{{ me.name }}</h2>

            <textarea class="form-control" msd-elastic placeholder="Digite aqui uma resposta..." ng-focus="newUserResponse.typing = true" ng-model="newUserResponse.message" ng-disabled="processingComment"></textarea>

            <div class="options" ng-show="newUserResponse.typing">
              <input type="checkbox" bs-switch switch-on-text="Privado" switch-off-text="Público" ng-model="newUserResponse.privateComment">

              <span class="help">{{ newUserResponse.privateComment == 0 ? 'Respostas públicas podem ser visualizadas por todos os usuários.' : 'Respostas privadas podem ser visualizadas apenas pelo munícipe solicitante.' }}</span>

              <button href="" class="btn btn-info btn-fat-custom btn-custom pull-right" ng-click="submitUserResponse()" ng-class="{'processing-comment': processingComment }" ng-disabled="processingComment">Enviar</button>
            </div>
          </div>

          <div class="clearfix"></div>
        </div>

        <hr />

        <div class="user-message animate-repeat" ng-repeat="comment in comments | orderBy:'created_at':true | filter: filterByUserMessages">
          <div class="avatar">
            <img src="assets/images/avatar_default.jpg" />
          </div>

          <div class="infos">
            <h2><a ng-href="#/users/{{ comment.author.id }}">{{ comment.author.name }}</a> <span>{{ comment.created_at | date:'dd/MM/yy HH:mm'}} &middot; {{ comment.visibility == 1 ? 'Resposta privada' : 'Resposta pública' }}</span></h2>

            <p class="comment-message">{{ comment.message }}</p>
          </div>

          <div class="clearfix"></div>

          <hr />
        </div>

      </div>
    </div>

    <div class="rounder_wrapper" id="report-comments" ng-show="hasPermission('reports_full_access') || hasPermission('reports_categories_edit', report.category.id) || hasPermission('reports_items_edit', report.category.id) || hasPermission('reports_items_read_private', report.category.id)">
      <div class="wrapper_title"><h1>Observações internas</h1></div>

      <div class="fields">
        <div class="user-message system-comment" ng-show="hasPermission('reports_full_access') || hasPermission('reports_categories_edit', report.category.id) || hasPermission('reports_items_edit', report.category.id) || hasPermission('reports_items_create_internal_comment', report.category.id)">
          <div class="avatar">
            <img src="assets/images/avatar_default.jpg" />
          </div>

          <div class="infos">
            <h2>{{ me.name }}</h2>

            <textarea class="form-control" msd-elastic placeholder="Digite aqui uma resposta..." ng-focus="newSystemComment.typing = true" ng-model="newSystemComment.message" ng-disabled="processingSystemComment"></textarea>

            <div class="options" ng-show="newSystemComment.typing">
              <button href="" class="btn btn-info btn-fat-custom btn-custom pull-right" ng-click="submitSystemComment()" ng-class="{'processing-comment': processingSystemComment }" ng-disabled="processingSystemComment">Publicar internamente</button>
            </div>
          </div>

          <div class="clearfix"></div>
        </div>

        <hr />

        <div class="user-message animate-repeat system-comment" ng-repeat="comment in comments | orderBy:'created_at':true | filter: {visibility: 2}">
          <div class="avatar">
            <img src="assets/images/avatar_default.jpg" />
          </div>

          <div class="infos">
            <h2><a ng-href="#/users/{{ comment.author.id }}">{{ comment.author.name }}</a> <span>{{ comment.created_at | date:'dd/MM/yy HH:mm'}}</span></h2>

            <p class="comment-message">{{ comment.message }}</p>
          </div>

          <div class="clearfix"></div>

          <hr />
        </div>

      </div>
    </div>

    <div class="rounder_wrapper" id="report-history">
      <div class="wrapper_title"><h1>Histórico</h1></div>

      <div class="item-history">

        <div class="filters">
          <div class="filter col-xs-3">
            <b>Exibir</b>

            <div class="btn-group">
              <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                <span class="pull-left">Tipos</span> <span class="pull-right"><span class="caret"></span></span>
              </button>

              <ul class="dropdown-menu" role="menu">
                <li ng-repeat="filter in availableHistoryFilters"><a href="" ng-click="toggleOption(filter)"> <b class="glyphicon glyphicon-ok" ng-show="filter.selected"></b> {{ filter.name }}</a></li>

                <li class="last"><a href="" ng-click="resetHistoryFilters()">Marcar todos</a></li>
              </ul>
            </div>
          </div>

          <div class="filter period col-xs-3">
            <b>Período</b>

            <div class="btn-group">
              <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                <span class="pull-left">Data</span> <span class="pull-right"><span class="caret"></span></span>
              </button>

              <ul class="dropdown-menu" role="menu">
                <li ng-repeat="filter in availableHistoryDateFilters" ng-class="{'active': filter.selected }"><a href="" ng-click="selectDateFilter(filter)">{{ filter.name }}</a></li>
                <li class="divider"></li>
                <li ng-class="{ 'active': showCustomDateHelper }"><a href="" ng-click="showCustomDateFields()">Por período</a></li>
              </ul>
            </div>
          </div>

          <div class="filter datepicker col-xs-2 pages-animation" ng-show="showCustomDateHelper">
            <input type="text" class="form-control" datepicker-popup="dd/MM/yyyy" ng-model="historyFilterBeginDate" show-weeks="false" show-button-bar="false" ng-change="refreshHistory()" />
          </div>

          <span class="filter until col-xs-1 pages-animation" ng-show="showCustomDateHelper">até</span>

          <div class="filter datepicker last col-xs-2" ng-show="showCustomDateHelper">
            <input type="text" class="form-control" datepicker-popup="dd/MM/yyyy" ng-model="historyFilterEndDate" show-weeks="false" show-button-bar="false" ng-change="refreshHistory()" />
          </div>

          <div class="clearfix"></div>
        </div>

        <div class="timeline">

          <div class="loadingHistoryLogs pages-animation" ng-show="loadingHistoryLogs"><span></span></div>

          <div class="empty" ng-show="historyLogs.length === 0"><p>Não há alterações cadastradas.</p></div>

          <div class="line"><span></span></div>

          <div class="log" ng-repeat="log in historyLogs">
            <div class="date">
              <span>{{ log.created_at | date:'dd/MM/yy HH:mm'}}h</span>
            </div>

            <div class="action">
              <p>
                <a ng-href="#/users/{{ log.user.id }}" ng-if="log.user">{{ log.user.name }}</a>
                <span ng-if="!log.user && log.kind !== 'overdue'">O sistema </span>
                <span ng-show="log.kind === 'status' && log.user">alterou o estado do relato de <b>{{ log.changes.old.title }}</b> para <b>{{ log.changes.new.title }}</b>.</span>
                <span ng-show="log.kind === 'status' && !log.user">alterou o estado do relato de <b>{{ log.changes.old.title }}</b> para <b>{{ log.changes.new.title }}</b>.</span>
                <span ng-show="log.kind === 'overdue'">O Relato entrou em atraso às <b>{{ log.created_at | date:'HH:mm'}}</b> quando estava no estado: <b>{{ overdue_status }}</b>.</span>
                <span ng-show="log.kind === 'address'">alterou o endereço do relato para <b>{{ log.changes.new }}</b>.</span>
                <span ng-show="log.kind === 'description'">alterou a descrição do relato para <b>{{ log.changes.new }}</b>.</span>
                <span ng-show="log.kind === 'category'">alterou a categoria do relato de <b>{{ log.changes.old.title }}</b> para <b>{{ log.changes.new.title }}</b>.</span>
                <span ng-show="log.kind === 'user_assign'">associou o relato<span ng-show="log.changes.old"> do usuário <a ng-href="#/groups/{{ log.changes.old.id }}">{{ log.changes.old.name }}</a></span> para o usuário <a href="#/users/{{ log.changes.new.id }}">{{ log.changes.new.name }}</a>.</span>
                <span ng-show="log.kind === 'forward'">encaminhou o relato<span ng-show="log.changes.old"> do grupo <a ng-href="#/groups/{{ log.changes.old.id }}">{{ log.changes.old.name }}</a></span> para o grupo <a href="#/groups/{{ log.changes.new.id }}">{{ log.changes.new.name }}</a>.</span>
                <span ng-show="log.kind === 'comment' && log.changes.new.visibility == 0">inseriu uma resposta pública ao munícipe: <b>{{ log.changes.new.message }}</b>.</span>
                <span ng-show="log.kind === 'comment' && log.changes.new.visibility == 1">inseriu uma resposta privada ao munícipe: <b>{{ log.changes.new.message }}</b>.</span>
                <span ng-show="log.kind === 'comment' && log.changes.new.visibility == 2">inseriu o comentáro interno: <b>{{ log.changes.new.message }}</b>.</span>

                <span ng-show="log.kind === 'creation'"> criou o relato com o estado <b>{{ log.changes.new.title }}</b>.</span>
              </p>

              <div class="divider"></div>
            </div>

            <div class="clearfix"></div>
          </div>

        </div>

      </div>
    </div>

  </div>
</div>
